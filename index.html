<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ë‹¤ì´ì–´íŠ¸ RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- âœ… PWA í•„ìˆ˜(ì¶”ê°€) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00ff99">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --bg:#0e0e0e; --card:#1c1c1c; --card2:#171717; --text:#fff; --muted:#bbb;
  --green:#4caf50; --gray:#777; --red:#c62828; --blue:#2d9cdb; --amber:#ff9800;

  --radius: 14px;
  --shadow: 0 8px 22px rgba(0,0,0,.35);
  --font: Arial, sans-serif;
}
html,body{background:var(--bg);color:var(--text);font-family:var(--font);margin:0}
body{padding:72px 12px 12px}
h1,h2{margin:10px 0;text-align:center}
a{color:inherit;text-decoration:none}
.card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;position:relative;box-shadow:var(--shadow)}
button,input,textarea,select{width:100%;padding:12px;margin-top:6px;border:none;border-radius:calc(var(--radius) - 4px);font-size:15px;box-sizing:border-box}
button{background:var(--green);color:#fff;font-weight:bold;transition:transform .08s ease, filter .08s ease}
button:active{transform:scale(.96);filter:brightness(1.1)}
button:disabled{opacity:.45;filter:grayscale(.2);transform:none;cursor:not-allowed}
.gray{background:var(--gray)}
.red{background:var(--red)}
.blue{background:var(--blue)}
.amber{background:var(--amber)}
.lock{opacity:.4}
.bar-bg{background:#333;height:18px;border-radius:10px;overflow:hidden}
.bar{height:100%;transition:width .35s ease}
.xp{background:linear-gradient(90deg,#00ff99,#00ccff)}
.hp{background:#ff5555}
.boss{background:#ff9800}
.row{display:flex;justify-content:space-between;font-size:14px;margin-bottom:4px;gap:10px;align-items:center}
.row .muted{color:var(--muted)}
#msg{text-align:center;font-weight:bold;margin-top:6px;min-height:20px}
.canvas-wrap{background:var(--card2);border-radius:12px;padding:10px;margin-top:8px}
canvas{width:100%;height:220px}

.gear-item{padding:10px;border-radius:12px;background:var(--card2);margin-top:8px}
.gear-sub{font-size:12px;color:#ccc;margin-top:4px}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border-radius:999px;background:#2a2a2a;font-size:13px}
.pill.ok{background:rgba(76,175,80,.25);border:1px solid rgba(76,175,80,.55)}
.pill.no{background:rgba(255,85,85,.18);border:1px solid rgba(255,85,85,.45)}
.pill.warn{background:rgba(255,152,0,.15);border:1px solid rgba(255,152,0,.45)}
.pill.info{background:rgba(45,156,219,.15);border:1px solid rgba(45,156,219,.45)}

hr{border:none;border-top:1px solid #2b2b2b;margin:10px 0}

/* UI ì• ë‹ˆë©”ì´ì…˜ */
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)}}
.shake{animation:shake .18s}
@keyframes glow{0%{box-shadow:0 0 0 rgba(0,255,153,0)}50%{box-shadow:0 0 22px rgba(0,255,153,.55)}100%{box-shadow:0 0 0 rgba(0,255,153,0)}}
.levelup{animation:glow .6s}
.damage{
 position:absolute;left:50%;top:48%;transform:translateX(-50%);
 font-weight:900;text-shadow:0 2px 10px rgba(0,0,0,.7);
 pointer-events:none;animation:floatUp .55s ease forwards;
}
@keyframes floatUp{from{opacity:1;transform:translate(-50%,0) scale(1)}to{opacity:0;transform:translate(-50%,-42px) scale(1.05)}}
.overlay{
 position:fixed;inset:0;background:rgba(0,0,0,.85);
 display:none;align-items:center;justify-content:center;
 font-size:30px;font-weight:900;z-index:9999;
}
.overlay.show{display:flex;animation:pop .22s ease}
@keyframes pop{from{transform:scale(.96);opacity:.7}to{transform:scale(1);opacity:1}}

/* ìƒë‹¨ ê³ ì • í€µë„¤ë¹„ */
.nav{
 position:fixed;left:0;right:0;top:0;z-index:999;
 background:rgba(14,14,14,.92);
 border-bottom:1px solid #222;
 backdrop-filter: blur(6px);
 padding:10px 10px;
 display:flex;align-items:center;gap:8px;overflow:auto;
}
.nav .brand{font-weight:900;white-space:nowrap;margin-right:4px}
.nav a{
 white-space:nowrap;
 padding:8px 10px;border-radius:999px;background:#1f1f1f;
 font-size:13px;opacity:.95
}
.nav a:active{transform:scale(.98)}
.nav .spacer{flex:1}
.nav .mini{
 padding:8px 10px;border-radius:999px;background:#1f1f1f;font-size:13px;
 width:auto !important; margin-top:0 !important; color:var(--text);
}
.nav .mini.gray{background:#1f1f1f}
.nav select.mini{outline:none}

/* ì•„ì½”ë””ì–¸ */
details{background:transparent}
summary{cursor:pointer;list-style:none}
summary::-webkit-details-marker{display:none}
.summaryRow{display:flex;justify-content:space-between;align-items:center}
.chev{opacity:.6}
details[open] .chev{transform:rotate(180deg)}

/* ëª¨ë‹¬ */
.modalBack{
 position:fixed;inset:0;background:rgba(0,0,0,.6);
 display:none;align-items:center;justify-content:center;z-index:9998;padding:14px;
}
.modalBack.show{display:flex}
.modal{
 width:min(560px, 100%);
 background:#121212;border:1px solid #2a2a2a;border-radius:16px;
 padding:14px;
}
.modal h3{margin:0 0 8px 0}
.modal .actions{display:flex;gap:8px;margin-top:10px}
.modal .actions button{width:50%}
.small{font-size:12px;color:var(--muted);line-height:1.55}
.clickable{cursor:pointer}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}

/* ë„ì›€ë§ ë²„íŠ¼ */
.helpBtn{
  width:auto !important;
  padding:8px 10px !important;
  border-radius:999px !important;
  background:#1f1f1f !important;
  font-size:13px !important;
  margin-top:0 !important;
  color:var(--text) !important;
}
.helpBtn:active{transform:scale(.98)}
.helpTitle{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#232323;font-size:12px;color:#ddd}
.ul{margin:8px 0 0 0;padding-left:18px}
.ul li{margin:6px 0}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px;margin-top:10px}
.kv div{padding:6px 8px;border-radius:10px;background:#171717}
.kv .k{color:#ddd}
.kv .v{color:#bbb}

/* í€˜ìŠ¤íŠ¸ */
.qItem{background:var(--card2);border-radius:12px;padding:10px;margin-top:8px}
.qTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
.qTitle{font-weight:800}
.qDesc{font-size:12px;color:#cfcfcf;margin-top:4px;line-height:1.45}
.qMeta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#232323;color:#ddd}
.tag.ok{background:rgba(76,175,80,.18);border:1px solid rgba(76,175,80,.45)}
.tag.no{background:rgba(255,85,85,.14);border:1px solid rgba(255,85,85,.35)}
.tag.info{background:rgba(45,156,219,.14);border:1px solid rgba(45,156,219,.35)}
.smallBtn{width:auto !important;padding:8px 10px !important;border-radius:10px !important;font-size:13px !important;margin-top:0 !important}

/* ìŠ¤í‚¨ ì ê¹€ í‘œì‹œ */
.lockOpt{opacity:.55}

/* ===== ìŠ¤í‚¨ 3ì¢… ===== */
/* ë©”ì´í”Œí’ */
body.skin-maple{
  --bg:#0f1021;
  --card:#1a1740;
  --card2:#151233;
  --text:#ffffff;
  --muted:#d5d6ff;

  --green:#ff8ccf;
  --blue:#6fb7ff;
  --red:#ff5b7e;
  --amber:#ffd25e;
  --gray:#6f74a6;

  --radius:18px;
  --shadow: 0 10px 26px rgba(0,0,0,.45);
  --font: "Trebuchet MS", Arial, sans-serif;
}
body.skin-maple .xp{background:linear-gradient(90deg,#ffd25e,#ff8ccf)}
body.skin-maple .boss{background:linear-gradient(90deg,#ff9f43,#ff5b7e)}
body.skin-maple .nav{background:rgba(15,16,33,.92);border-bottom:1px solid rgba(255,255,255,.08)}
body.skin-maple .nav a, body.skin-maple .nav .mini, body.skin-maple .helpBtn{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
}

/* ë„¤ì˜¨ */
body.skin-neon{
  --bg:#05070a;
  --card:#0b121a;
  --card2:#071019;
  --text:#eaffff;
  --muted:#a2c7d1;

  --green:#00ff99;
  --blue:#00ccff;
  --red:#ff2a6d;
  --amber:#ffb000;
  --gray:#5b7a86;

  --radius:14px;
  --shadow: 0 0 0 rgba(0,0,0,0);
  --font: Arial, sans-serif;
}
body.skin-neon .card{
  box-shadow:
    0 0 0 1px rgba(0,255,153,.12),
    0 10px 24px rgba(0,0,0,.55);
}
body.skin-neon .xp{background:linear-gradient(90deg,#00ff99,#00ccff)}
body.skin-neon .hp{background:linear-gradient(90deg,#ff2a6d,#ff5b7e)}
body.skin-neon .boss{background:linear-gradient(90deg,#ffb000,#ff2a6d)}
body.skin-neon .nav{background:rgba(5,7,10,.92);border-bottom:1px solid rgba(0,255,153,.18)}
body.skin-neon .nav a, body.skin-neon .nav .mini, body.skin-neon .helpBtn{
  background:rgba(0,255,153,.08);
  border:1px solid rgba(0,255,153,.18);
}

/* ë ˆíŠ¸ë¡œ ê²Œì„ë³´ì´ */
body.skin-retro{
  --bg:#c6d8a8;
  --card:#dfe8c8;
  --card2:#cdddb2;
  --text:#1f2d16;
  --muted:#4a5a3a;

  --green:#4b6f44;
  --blue:#3f5f8a;
  --red:#7a3e3e;
  --amber:#8a7a2f;
  --gray:#5a6b50;

  --radius:6px;
  --shadow:none;
  --font: "Courier New", monospace;
}
body.skin-retro .bar-bg{background:#9fb58a}
body.skin-retro .xp,
body.skin-retro .boss{background:#4b6f44}
body.skin-retro .nav{
  background:#b8cfa0;
  border-bottom:2px solid #5a6b50;
}
body.skin-retro .nav a,
body.skin-retro .nav .mini,
body.skin-retro .helpBtn{
  background:#dfe8c8;
  border:2px solid #5a6b50;
}
body.skin-retro .card{border:2px solid #5a6b50}
body.skin-retro .pill,
body.skin-retro .tag,
body.skin-retro .badge{
  background:#cdddb2;
  border:1px solid #5a6b50;
  color:var(--text);
}
body.skin-retro .kv div{background:#cdddb2}
</style>
</head>
<body>

<div class="nav">
  <div class="brand">ğŸ”¥ ë‹¤ì´ì–´íŠ¸RPG</div>
  <a href="#status">ìƒíƒœ</a>
  <a href="#quest">í€˜ìŠ¤íŠ¸</a>
  <a href="#work">ìš´ë™</a>
  <a href="#meal">ì‹ë‹¨</a>
  <a href="#boss">ë³´ìŠ¤</a>
  <a href="#gearSec">ì¥ë¹„</a>
  <a href="#cal">ìº˜ë¦°ë”</a>
  <a href="#stats">ê·¸ë˜í”„</a>
  <div class="spacer"></div>

  <select id="skinSelect" class="mini" onchange="setSkin(this.value)"></select>

  <button class="mini gray" onclick="openBackup()">ë°±ì—…/ë³µì›</button>
  <button class="mini gray" onclick="openHelp('all')">ì„¤ëª…</button>
</div>

<h1>ğŸ”¥ ë‹¤ì´ì–´íŠ¸ RPG ğŸ”¥</h1>

<div class="card" id="status">
  <div class="helpTitle">
    <h2 style="margin:0">ìƒíƒœ</h2>
    <button class="helpBtn" onclick="openHelp('status')">ì„¤ëª…</button>
  </div>

  <div class="row">ë ˆë²¨ <span id="lv"></span></div>
  <div class="row">XP <span id="xpText"></span></div>
  <div class="bar-bg"><div class="bar xp" id="xpBar"></div></div>
  <hr>
  <div class="row">HP <span id="hpText"></span></div>
  <div class="bar-bg"><div class="bar hp" id="hpBar"></div></div>
  <div class="row">ê³µê²©ë ¥ <span id="atk"></span></div>
  <div class="row">ì¹˜ëª…íƒ€ <span id="crit"></span>%</div>
  <div class="row">ìŠ¤íƒ¯ í¬ì¸íŠ¸ <span id="sp"></span></div>
  <div class="row">ê°•í™” ì¬ë£Œ <span id="mat"></span></div>
  <div class="row">ì—°ì† ì¶œì„ <span id="streak"></span>ì¼ <span class="muted" id="streakNext"></span></div>

  <div class="pills" id="todayPills"></div>
  <div class="row"><span class="muted">ì˜¤ëŠ˜ ì˜¬í´ë¦¬ì–´</span><span id="dailyProgress"></span></div>

  <div id="msg"></div>
</div>

<div class="card" id="quest">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ§¾ í€˜ìŠ¤íŠ¸</h2>
          <button class="helpBtn" onclick="openHelp('quest')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>

    <div class="row">
      <span class="muted">ì¼ì¼</span>
      <span class="muted" id="dailyQuestKey"></span>
    </div>
    <div id="dailyQuests"></div>

    <hr>

    <div class="row">
      <span class="muted">ì£¼ê°„</span>
      <span class="muted" id="weeklyQuestKey"></span>
    </div>
    <div id="weeklyQuests"></div>
  </details>
</div>

<div class="card">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ“ˆ ìŠ¤íƒ¯ ë¶„ë°°</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="badge">Bì•ˆ ë¡¤ë°±</span>
            <button class="helpBtn" onclick="openHelp('stats')">ì„¤ëª…</button>
          </div>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>
    <button onclick="addStat('hp')">HP +10</button>
    <button onclick="addStat('atk')">ê³µê²©ë ¥ +1</button>
    <button onclick="addStat('crit')">ì¹˜ëª…íƒ€ +0.5%</button>
  </details>
</div>

<div class="card" id="work">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸƒ ìš´ë™</h2>
          <button class="helpBtn" onclick="openHelp('work')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>

    <input id="kmInput" type="number" step="0.1" placeholder="ë‹¬ë¦¬ê¸° km">
    <button id="runBtn" onclick="addRun()">ë‹¬ë¦¬ê¸°</button>

    <div class="grid2">
      <button class="gray" id="editRunBtn" onclick="editTodayRun()">ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ìˆ˜ì •</button>
      <button class="gray" id="undoRunBtn" onclick="undoToday('run')">ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ì·¨ì†Œ</button>
    </div>

    <button id="workoutBtn" onclick="confirmWorkout()">ê·¼ë ¥ìš´ë™ (+50 XP)</button>

    <div class="grid2">
      <button class="gray" id="undoWorkoutBtn" onclick="undoToday('workout')">ì˜¤ëŠ˜ ê·¼ë ¥ìš´ë™ ì·¨ì†Œ</button>
      <button class="gray" disabled style="opacity:.2"> </button>
    </div>
  </details>
</div>

<div class="card" id="meal">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ± ì‹ë‹¨</h2>
          <button class="helpBtn" onclick="openHelp('meal')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>

    <div class="grid2">
      <button id="mealOkBtn" onclick="confirmMeal(true)">ì‹ë‹¨ ì„±ê³µ</button>
      <button class="gray" id="mealNoBtn" onclick="confirmMeal(false)">ì‹ë‹¨ ì‹¤íŒ¨</button>
    </div>

    <div class="grid2">
      <button class="gray" id="editMealBtn" onclick="editTodayMeal()">ì˜¤ëŠ˜ ì‹ë‹¨ ìˆ˜ì •</button>
      <button class="gray" id="undoMealBtn" onclick="undoToday('meal')">ì˜¤ëŠ˜ ì‹ë‹¨ ì·¨ì†Œ</button>
    </div>
  </details>
</div>

<div class="card" id="boss">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ‘¹ ë³´ìŠ¤</h2>
          <button class="helpBtn" onclick="openHelp('boss')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>

    <div id="bossCard">
      <div class="row">ë³´ìŠ¤ Lv <span id="bossLv"></span> <span class="muted">(ATK <span id="bossAtk"></span>)</span></div>

      <div class="row">
        <span class="muted">íŒ¨í„´</span>
        <span id="patternText" class="pill info" style="margin:0;padding:4px 10px;display:inline-block;border-radius:999px">-</span>
      </div>

      <div class="row">ë³´ìŠ¤ HP <span id="bossHpText"></span></div>
      <div class="bar-bg"><div class="bar boss" id="bossHpBar"></div></div>

      <div class="row">ë‚´ HP <span id="battleHpText"></span></div>
      <div class="bar-bg"><div class="bar hp" id="battleHpBar"></div></div>

      <div class="grid2">
        <button id="bossBtn" onclick="startBoss()">ë³´ìŠ¤ì „ ì‹œì‘</button>
        <button id="dodgeBtn" class="blue" onclick="useDodge()" disabled>íšŒí”¼</button>
      </div>

      <div id="timer" class="small"></div>
      <div id="patternHint" class="small"></div>
    </div>
  </details>
</div>

<div class="card" id="gearSec">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ›¡ï¸ ì¥ë¹„</h2>
          <button class="helpBtn" onclick="openHelp('gear')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>
    <div id="gear"></div>
  </details>
</div>

<div class="card" id="cal">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ“… ìº˜ë¦°ë”</h2>
          <button class="helpBtn" onclick="openHelp('calendar')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>
    <div class="small">â€» ë‚ ì§œë¥¼ ëˆ„ë¥´ë©´ ìƒì„¸ê°€ ëœ¹ë‹ˆë‹¤.</div>
    <div id="calendar" style="margin-top:8px"></div>
  </details>
</div>

<div class="card" id="stats">
  <details open>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">ğŸ“Š ê·¸ë˜í”„</h2>
          <button class="helpBtn" onclick="openHelp('charts')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>

    <div class="row">
      <span class="muted">ê¸°ê°„</span>
      <span>
        <button class="gray" style="width:auto;padding:8px 10px" onclick="setChartDays(7)">7ì¼</button>
        <button class="gray" style="width:auto;padding:8px 10px" onclick="setChartDays(30)">30ì¼</button>
      </span>
    </div>

    <div class="canvas-wrap">
      <div class="row"><span>ë‹¬ë¦¬ê¸°(km)</span><span class="muted" id="chartRange1"></span></div>
      <canvas id="runChart"></canvas>
    </div>

    <div class="canvas-wrap">
      <div class="row"><span>XP ë³€í™”(íšë“ XP)</span><span class="muted" id="chartRange2"></span></div>
      <canvas id="xpChart"></canvas>
    </div>
  </details>
</div>

<div class="card">
  <details>
    <summary>
      <div class="summaryRow">
        <div class="helpTitle" style="width:100%">
          <h2 style="margin:0">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</h2>
          <button class="helpBtn" onclick="openHelp('reset')">ì„¤ëª…</button>
        </div>
        <span class="chev">â–¾</span>
      </div>
    </summary>
    <div class="small">ì•ˆì „ì¥ì¹˜: â€œRESETâ€ì„ ì§ì ‘ ì…ë ¥í•´ì•¼ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</div>
    <button class="red" onclick="resetAll()">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
  </details>
</div>

<div class="overlay" id="overlay"></div>

<!-- ë‚ ì§œ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modalBack" id="detailModalBack" onclick="closeDetail(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>ğŸ“Œ ë‚ ì§œ ìƒì„¸</h3>
    <div id="detailBody" class="small"></div>
    <div class="actions">
      <button class="gray" onclick="closeDetail()">ë‹«ê¸°</button>
      <button onclick="jumpToToday()">ì˜¤ëŠ˜ë¡œ</button>
    </div>
  </div>
</div>

<!-- ë°±ì—…/ë³µì› ëª¨ë‹¬ -->
<div class="modalBack" id="backupModalBack" onclick="closeBackup(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>ğŸ’¾ ë°±ì—… / ë³µì›</h3>
    <div class="small">ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ ì €ì¥í•˜ê±°ë‚˜, ë³µì›í•  í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  â€œë³µì›â€ì„ ëˆ„ë¥´ì„¸ìš”.</div>
    <textarea id="backupText" rows="8" placeholder="ì—¬ê¸°ì— ë°±ì—… í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
    <div class="actions">
      <button class="gray" onclick="copyBackup()">ë³µì‚¬</button>
      <button onclick="restoreBackup()">ë³µì›</button>
    </div>
    <button class="gray" onclick="closeBackup()" style="margin-top:8px">ë‹«ê¸°</button>
  </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modalBack" id="editModalBack" onclick="closeEdit(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="editTitle">âœï¸ ìˆ˜ì •</h3>
    <div id="editBody" class="small"></div>
    <div class="actions">
      <button class="gray" onclick="closeEdit()">ì·¨ì†Œ</button>
      <button onclick="applyEdit()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ì„¤ëª…(ë„ì›€ë§) ëª¨ë‹¬ -->
<div class="modalBack" id="helpModalBack" onclick="closeHelp(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="helpTitle">ğŸ“– ì„¤ëª…</h3>
    <div id="helpBody" class="small"></div>
    <div class="actions">
      <button class="gray" onclick="closeHelp()">ë‹«ê¸°</button>
      <button onclick="openHelp('all')">ì „ì²´</button>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const $ = id => document.getElementById(id);
const today = () => new Date().toISOString().slice(0,10);

let msgTimer=null;
function showMsg(t){
  $("msg").innerText=t;
  if(msgTimer) clearTimeout(msgTimer);
  msgTimer=setTimeout(()=>{$("msg").innerText="";},2200);
}
function flashOverlay(text){
  const o=$("overlay");
  o.textContent=text;
  o.classList.add("show");
  setTimeout(()=>o.classList.remove("show"),900);
}
function damagePopup(text,isCrit=false){
  const d=document.createElement("div");
  d.className="damage";
  d.style.color=isCrit ? "#ff4444" : "#ffffff";
  d.textContent=text;
  $("bossCard").appendChild(d);
  setTimeout(()=>d.remove(),600);
}
function addDaysISO(iso, days){
  const dt=new Date(iso+"T00:00:00");
  dt.setDate(dt.getDate()+days);
  return dt.toISOString().slice(0,10);
}
function fmtMMDD(iso){ return iso.slice(5,7)+"/"+iso.slice(8,10); }

/* =========================
   ë³´ìŠ¤ ìŠ¤ì¼€ì¼
========================= */
function bossHpForLevel(lv){ return 1000 + (Math.max(1,lv)-1) * 100; }
function bossAtkForLevel(lv){ return 2 + (Math.max(1,lv)-1) * 1; }

/* =========================
   ìƒíƒœ ë¡œë“œ/ì´ˆê¸°ê°’
========================= */
let state = JSON.parse(localStorage.getItem("state")) || {
  lv:1, xp:0, maxXp:100,
  maxHp:50, hp:50, atk:5, crit:5,
  mat:0, runSum:0,
  bossLv:1, bossHp:bossHpForLevel(1), bossAtk:bossAtkForLevel(1),
  gears:[
    {name:"ìš´ë™í™”",lv:0,req:5},
    {name:"ìš´ë™ë³µ",lv:0,req:10},
    {name:"ì†ëª©ë°´ë“œ",lv:0,req:15},
    {name:"í—¤ë“œì…‹",lv:0,req:20}
  ],
  streak:0,
  lastStreakDate:"",
  lastStreakRewardDate:"",
  spentSP:0,
  statLog:[],
  quests:{ dailyKey:"", weeklyKey:"", claimed:{} },

  /* âœ… ìŠ¤í‚¨: ë„¤ì˜¨ ê¸°ë³¸ / ë©”ì´í”Œí’(ë ˆë²¨10) / ë ˆíŠ¸ë¡œ(ì—°ì†ì¶œì„15ì¼) */
  skins: {
    current: "neon",
    unlocked: { neon:true, maple:false, retro:false },
    seenUnlock: { neon:true, maple:false, retro:false }
  }
};

let records = JSON.parse(localStorage.getItem("records")) || {};
let battle=null, bossTimer=null;

/* ëˆ„ë½ ë³´ì • */
state.lv ??= 1;
state.xp ??= 0;
state.maxXp ??= (100 + 50*(state.lv-1));
state.maxHp ??= 50;
state.hp ??= Math.min(state.hp ?? state.maxHp, state.maxHp);
state.atk ??= 5;
state.crit ??= 5;
state.mat ??= 0;
state.runSum ??= 0;

state.bossLv ??= 1;
state.bossHp = bossHpForLevel(state.bossLv);
state.bossAtk = bossAtkForLevel(state.bossLv);

state.gears ??= [
  {name:"ìš´ë™í™”",lv:0,req:5},
  {name:"ìš´ë™ë³µ",lv:0,req:10},
  {name:"ì†ëª©ë°´ë“œ",lv:0,req:15},
  {name:"í—¤ë“œì…‹",lv:0,req:20}
];
state.streak ??= 0;
state.lastStreakDate ??= "";
state.lastStreakRewardDate ??= "";
state.spentSP ??= 0;
state.statLog ??= [];
state.quests ??= {dailyKey:"", weeklyKey:"", claimed:{}};
state.quests.claimed ??= {};

/* âœ… ìŠ¤í‚¨ ê¸°ë³¸ê°’ ê°•ì œ */
state.skins ??= { current:"neon", unlocked:{neon:true,maple:false,retro:false}, seenUnlock:{neon:true,maple:false,retro:false} };
state.skins.current ??= "neon";
state.skins.unlocked ??= {neon:true,maple:false,retro:false};
state.skins.seenUnlock ??= {neon:true,maple:false,retro:false};
state.skins.unlocked.neon = true;
state.skins.seenUnlock.neon = true;

function save(){
  localStorage.setItem("state", JSON.stringify(state));
  localStorage.setItem("records", JSON.stringify(records));
}

/* =========================
   ìŠ¤í‚¨(í…Œë§ˆ) ì‹œìŠ¤í…œ (í‘œì‹œ ìˆœì„œ: ë„¤ì˜¨ â†’ ë©”ì´í”Œí’ â†’ ë ˆíŠ¸ë¡œ)
========================= */
const SKIN_REQ = {
  neon:   { label:"ë„¤ì˜¨", reqText:"ê¸°ë³¸" },
  maple:  { label:"ë©”ì´í”Œí’", reqText:"í•´ê¸ˆ: ë ˆë²¨ 10" },
  retro:  { label:"ë ˆíŠ¸ë¡œ ê²Œì„ë³´ì´", reqText:"í•´ê¸ˆ: ì—°ì†ì¶œì„ 15ì¼" }
};

function applySkinClass(skin){
  const b=document.body;
  b.classList.remove("skin-neon","skin-maple","skin-retro");
  if(skin==="neon") b.classList.add("skin-neon");
  else if(skin==="retro") b.classList.add("skin-retro");
  else b.classList.add("skin-maple");
}

function setSkin(skin){
  if(!state.skins.unlocked[skin]){
    showMsg("ğŸ”’ ì•„ì§ í•´ê¸ˆë˜ì§€ ì•Šì€ ìŠ¤í‚¨ì…ë‹ˆë‹¤");
    flashOverlay("LOCKED");
    renderSkinSelect();
    return;
  }
  state.skins.current = skin;
  applySkinClass(skin);
  showMsg(`ğŸ¨ ìŠ¤í‚¨ ë³€ê²½: ${SKIN_REQ[skin]?.label || skin}`);
  save();
}

function renderSkinSelect(){
  const sel = $("skinSelect");
  if(!sel) return;

  const cur = state.skins.current || "neon";
  const unlocked = state.skins.unlocked;

  const opts = ["neon","maple","retro"].map(k=>{
    const isUnlocked = !!unlocked[k];
    const label = SKIN_REQ[k]?.label || k;
    const text = isUnlocked ? label : `??? (${SKIN_REQ[k]?.reqText || "í•´ê¸ˆ ì¡°ê±´"})`;
    return `<option value="${k}" ${isUnlocked?"":"disabled"} class="${isUnlocked?"":"lockOpt"}">${text}</option>`;
  }).join("");

  sel.innerHTML = opts;

  if(!unlocked[cur]){
    state.skins.current = "neon";
    applySkinClass("neon");
  }
  sel.value = state.skins.current;
}

function tryUnlockSkins(){
  const mapleOk = (state.lv >= 10);
  if(mapleOk && !state.skins.unlocked.maple){
    state.skins.unlocked.maple = true;
    if(!state.skins.seenUnlock.maple){
      state.skins.seenUnlock.maple = true;
      showMsg("ğŸ‰ ìŠ¤í‚¨ í•´ê¸ˆ: ë©”ì´í”Œí’!");
      flashOverlay("NEW SKIN!");
    }
  }

  const retroOk = (state.streak||0) >= 15;
  if(retroOk && !state.skins.unlocked.retro){
    state.skins.unlocked.retro = true;
    if(!state.skins.seenUnlock.retro){
      state.skins.seenUnlock.retro = true;
      showMsg("ğŸ‰ ìŠ¤í‚¨ í•´ê¸ˆ: ë ˆíŠ¸ë¡œ ê²Œì„ë³´ì´!");
      flashOverlay("NEW SKIN!");
    }
  }
}

function initSkin(){
  if(!state.skins.unlocked[state.skins.current]) state.skins.current="neon";
  applySkinClass(state.skins.current);
  renderSkinSelect();
}

/* =========================
   ë ˆë²¨/XP ì •í•©ì„± (ê°ì†Œ í¬í•¨)
========================= */
function totalXPFromState(){
  const L = Math.max(1, state.lv|0);
  const xp = Math.max(0, Math.floor(state.xp||0));
  const sumPrev = 100*(L-1) + 25*(L-1)*(L-2);
  return Math.max(0, sumPrev + xp);
}
function setStateFromTotalXP(total){
  total = Math.max(0, Math.floor(total));
  let lv = 1;
  let need = 100;
  while(total >= need){
    total -= need;
    lv += 1;
    need += 50;
  }
  state.lv = lv;
  state.maxXp = need;
  state.xp = total;
  reconcileStatPoints();
}

/* =========================
   Bë°©ì‹ ìŠ¤íƒ¯ ë¡¤ë°± (ìµœê·¼ë¶€í„°)
========================= */
function totalSP(){ return Math.max(0, state.lv - 1); }
function freeSP(){ return Math.max(0, totalSP() - (state.spentSP||0)); }

function rollbackOneStat(type){
  if(type==="hp"){
    state.maxHp = Math.max(0, state.maxHp - 10);
    state.hp = Math.min(state.hp, state.maxHp);
  }
  if(type==="atk"){
    state.atk = Math.max(0, state.atk - 1);
  }
  if(type==="crit"){
    state.crit = Math.max(0, state.crit - 0.5);
  }
}
function reconcileStatPoints(){
  let rolled = 0;
  while((state.spentSP||0) > totalSP()){
    const last = state.statLog.pop();
    if(!last){
      state.spentSP = totalSP();
      break;
    }
    rollbackOneStat(last);
    state.spentSP -= 1;
    rolled += 1;
  }
  if(rolled>0){
    showMsg(`â¬‡ï¸ ë ˆë²¨ í•˜ë½ìœ¼ë¡œ ìŠ¤íƒ¯ ${rolled}ê°œê°€ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤`);
  }
}
function addStat(type){
  if(freeSP() <= 0){ showMsg("â— ìŠ¤íƒ¯ í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"); return; }

  if(type==="hp"){ state.maxHp += 10; state.hp += 10; }
  if(type==="atk"){ state.atk += 1; }
  if(type==="crit"){ state.crit += 0.5; }

  state.spentSP += 1;
  state.statLog.push(type);

  showMsg("ğŸ“ˆ ìŠ¤íƒ¯ì´ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤");
  save(); render();
}

/* =========================
   ê¸°ë¡ ìœ í‹¸
========================= */
function ensureDay(d){
  records[d]=records[d]||{};
  if(records[d].xpGained===undefined) records[d].xpGained=0;
  if(records[d].xpParts===undefined) records[d].xpParts={};
  if(records[d].matParts===undefined) records[d].matParts={};
  if(records[d].bossWins===undefined) records[d].bossWins=0;
}

function addXpPart(d, key, amount){
  if(!amount) return;
  ensureDay(d);

  records[d].xpGained += amount;
  records[d].xpParts[key] = (records[d].xpParts[key]||0) + amount;

  const total = totalXPFromState();
  setStateFromTotalXP(total + amount);
}
function removeXpPart(d, key){
  ensureDay(d);
  const a = records[d].xpParts[key]||0;
  if(!a) return;

  const total = totalXPFromState();
  setStateFromTotalXP(total - a);

  records[d].xpGained = Math.max(0, (records[d].xpGained||0) - a);
  records[d].xpParts[key]=0;
}

function addMatPart(d, key, amount){
  if(!amount) return;
  ensureDay(d);
  records[d].matParts[key] = (records[d].matParts[key]||0) + amount;
  state.mat += amount;
}
function removeMatPart(d, key){
  ensureDay(d);
  const a = records[d].matParts[key]||0;
  if(!a) return;
  state.mat = Math.max(0, state.mat - a);
  records[d].matParts[key]=0;
}

/* =========================
   ì—°ì† ì¶œì„ + ë³´ë„ˆìŠ¤
========================= */
function updateStreakOnAction(d){
  if(state.lastStreakDate === d) return;

  const y = addDaysISO(d, -1);
  if(state.lastStreakDate === y){
    state.streak = (state.streak||0) + 1;
  }else{
    state.streak = 1;
  }
  state.lastStreakDate = d;

  if(state.streak > 0 && state.streak % 3 === 0 && state.lastStreakRewardDate !== d){
    const REWARD = 20;
    addXpPart(d, "streak", REWARD);
    state.lastStreakRewardDate = d;
    showMsg(`ğŸ”¥ ì—°ì† ${state.streak}ì¼! XP +${REWARD}`);
    flashOverlay("STREAK!");
  }
}

function checkDailyBonus(d){
  const r = records[d];
  if(!r) return;
  if(r.dailyBonusGiven) return;

  const hasRun = r.run !== undefined;
  const hasWorkout = r.workout === true;
  const mealSuccess = r.meal === true;

  if(hasRun && hasWorkout && mealSuccess){
    const BONUS_XP = 30;
    addXpPart(d, "dailyBonus", BONUS_XP);
    r.dailyBonusGiven = true;
    showMsg(`ğŸ ì˜¤ëŠ˜ ì˜¬í´ë¦¬ì–´! XP +${BONUS_XP}`);
    flashOverlay("BONUS!");
  }
}

/* =========================
   í€˜ìŠ¤íŠ¸ (ì¼ì¼/ì£¼ê°„) + ë³´ìƒ ìˆ˜ë ¹
========================= */
const DAILY_QUESTS = [
  { id:"run2k", title:"ëŸ¬ë‹ ìŠ¤íƒ€íŠ¸", desc:"ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° 2km ì´ìƒ", type:"daily",
    progress:()=>({cur: (getToday().run||0), max:2, text:`${(getToday().run||0)} / 2 km`} ),
    reward:{xp:30, mat:1}
  },
  { id:"workout1", title:"ê·¼ë ¥ ë£¨í‹´", desc:"ì˜¤ëŠ˜ ê·¼ë ¥ìš´ë™ 1íšŒ", type:"daily",
    progress:()=>({cur: (getToday().workout?1:0), max:1, text:`${getToday().workout?1:0} / 1`} ),
    reward:{xp:30, mat:0}
  },
  { id:"mealSuccess", title:"í´ë¦° í‘¸ë“œ", desc:"ì˜¤ëŠ˜ ì‹ë‹¨ ì„±ê³µ 1íšŒ", type:"daily",
    progress:()=>({cur: (getToday().meal===true?1:0), max:1, text:`${getToday().meal===true?1:0} / 1`} ),
    reward:{xp:20, mat:1}
  }
];

const WEEKLY_QUESTS = [
  { id:"run10k", title:"ì£¼ê°„ 10K", desc:"ì´ë²ˆ ì£¼ ë‹¬ë¦¬ê¸° í•© 10km", type:"weekly",
    progress:()=>{ const sum=weeklySumRun(); return {cur:sum, max:10, text:`${sum.toFixed(1)} / 10 km`}; },
    reward:{xp:0, mat:3}
  },
  { id:"boss3", title:"ì‚¬ëƒ¥ê¾¼", desc:"ì´ë²ˆ ì£¼ ë³´ìŠ¤ 3íšŒ ì²˜ì¹˜", type:"weekly",
    progress:()=>{ const w=weeklyBossWins(); return {cur:w, max:3, text:`${w} / 3`}; },
    reward:{xp:100, mat:0}
  },
  { id:"streak5", title:"ìŠµê´€ ìœ ì§€", desc:"ì—°ì† ì¶œì„ 5ì¼ ë‹¬ì„±", type:"weekly",
    progress:()=>{ const s=(state.streak||0); return {cur:Math.min(s,5), max:5, text:`${Math.min(s,5)} / 5`}; },
    reward:{xp:80, mat:0}
  }
];

function getToday(){
  const d=today(); ensureDay(d);
  return records[d] || {};
}

function mondayOfWeek(iso){
  const dt=new Date(iso+"T00:00:00");
  const day=dt.getDay();
  const diff = (day===0 ? -6 : 1-day);
  dt.setDate(dt.getDate()+diff);
  return dt.toISOString().slice(0,10);
}
function isoWeekKey(iso){ return mondayOfWeek(iso); }

function weeklyDates(){
  const m = mondayOfWeek(today());
  const arr=[];
  for(let i=0;i<7;i++) arr.push(addDaysISO(m, i));
  return {monday:m, days:arr};
}
function weeklyBossWins(){
  const {days} = weeklyDates();
  let sum=0;
  for(const d of days){
    if(records[d] && records[d].bossWins) sum += Number(records[d].bossWins)||0;
  }
  return sum;
}

function weeklySumRun(){
  const {days} = weeklyDates();
  let sum=0;
  for(const d of days){
    if(records[d] && records[d].run!==undefined) sum += Number(records[d].run)||0;
  }
  return sum;
}

function questKey(type){
  if(type==="daily") return today();
  return isoWeekKey(today());
}
function questClaimId(type,id){
  return (type==="daily" ? "D:" : "W:") + questKey(type) + ":" + id;
}
function ensureQuestReset(){
  const dKey = today();
  const wKey = isoWeekKey(today());
  if(state.quests.dailyKey !== dKey) state.quests.dailyKey = dKey;
  if(state.quests.weeklyKey !== wKey) state.quests.weeklyKey = wKey;
}

function isQuestClaimed(type,id){
  const cid = questClaimId(type,id);
  return !!state.quests.claimed[cid];
}
function setQuestClaimed(type,id){
  const cid = questClaimId(type,id);
  state.quests.claimed[cid]=true;
}

function claimQuest(type,id){
  ensureQuestReset();
  const list = (type==="daily") ? DAILY_QUESTS : WEEKLY_QUESTS;
  const q = list.find(x=>x.id===id);
  if(!q) return;

  const pr = q.progress();
  const done = (pr.cur >= pr.max);
  if(!done){ showMsg("ì•„ì§ ì¡°ê±´ì„ ë‹¬ì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤"); return; }
  if(isQuestClaimed(type,id)){ showMsg("ì´ë¯¸ ë³´ìƒì„ ë°›ì•˜ìŠµë‹ˆë‹¤"); return; }

  const d=today(); ensureDay(d);
  const xp = q.reward.xp||0;
  const mat = q.reward.mat||0;

  if(xp>0) addXpPart(d, `quest_${type}_${id}`, xp);
  if(mat>0) addMatPart(d, `quest_${type}_${id}`, mat);

  setQuestClaimed(type,id);
  showMsg(`âœ… ë³´ìƒ ìˆ˜ë ¹! ${xp?`XP +${xp} `:""}${mat?`ì¬ë£Œ +${mat}`:""}`.trim());
  flashOverlay("QUEST!");
  save(); render();
}

function renderQuestCard(q){
  const pr = q.progress();
  const done = pr.cur >= pr.max;
  const claimed = isQuestClaimed(q.type,q.id);
  const canClaim = done && !claimed;

  const rewardStr = `${q.reward.xp?`XP +${q.reward.xp}`:""}${(q.reward.xp&&q.reward.mat)?", ":""}${q.reward.mat?`ì¬ë£Œ +${q.reward.mat}`:""}`.trim();

  return `
    <div class="qItem">
      <div class="qTop">
        <div>
          <div class="qTitle">${q.title}</div>
          <div class="qDesc">${q.desc}</div>
        </div>
        <button class="smallBtn ${canClaim?"":"gray"}" ${canClaim?"":"disabled"} onclick="claimQuest('${q.type}','${q.id}')">
          ${claimed ? "ìˆ˜ë ¹ì™„ë£Œ" : (done ? "ë³´ìƒë°›ê¸°" : "ì§„í–‰ì¤‘")}
        </button>
      </div>
      <div class="qMeta">
        <span class="tag info">ì§„í–‰: ${pr.text}</span>
        <span class="tag ${done?"ok":"no"}">${done?"ì™„ë£Œ":"ë¯¸ì™„ë£Œ"}</span>
        <span class="tag">ë³´ìƒ: ${rewardStr || "-"}</span>
      </div>
    </div>
  `;
}

function renderQuests(){
  ensureQuestReset();
  $("dailyQuestKey").innerText = `(${today()})`;
  const {monday} = weeklyDates();
  $("weeklyQuestKey").innerText = `(${monday} ì‹œì‘)`;
  $("dailyQuests").innerHTML = DAILY_QUESTS.map(q=>renderQuestCard(q)).join("");
  $("weeklyQuests").innerHTML = WEEKLY_QUESTS.map(q=>renderQuestCard(q)).join("");
}

/* =========================
   ìš´ë™/ì‹ë‹¨
========================= */
function addRun(){
  const d=today(); ensureDay(d);
  if(records[d].run!==undefined) return;

  const km=parseFloat($("kmInput").value);
  if(!km||km<=0) return;

  records[d].run=km;

  addXpPart(d, "run", Math.floor(km*20));

  const before=Math.floor(state.runSum/10);
  state.runSum += km;
  const after=Math.floor(state.runSum/10);
  const gained = Math.max(0, after-before);
  if(gained>0){
    addMatPart(d, "run", gained);
    showMsg(`ğŸƒ ${km}km ë‹¬ë¦¬ê¸° ì™„ë£Œ (ì¬ë£Œ +${gained})`);
  }else{
    showMsg(`ğŸƒ ${km}km ë‹¬ë¦¬ê¸° ì™„ë£Œ`);
  }

  updateStreakOnAction(d);
  checkDailyBonus(d);
  save(); render();
}

function confirmWorkout(){
  if(!confirm("ğŸ’ª ì§„ì§œë¡œ ì˜¤ëŠ˜ ê·¼ë ¥ìš´ë™ì„ í–ˆë‚˜ìš”?\ní™•ì¸ì„ ëˆ„ë¥´ë©´ ì˜¤ëŠ˜ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.")) return;
  addWorkout();
}
function addWorkout(){
  const d=today(); ensureDay(d);
  if(records[d].workout) return;

  records[d].workout=true;
  addXpPart(d, "workout", 50);
  showMsg("ğŸ’ª ê·¼ë ¥ìš´ë™ ì™„ë£Œ (+50 XP)");

  updateStreakOnAction(d);
  checkDailyBonus(d);
  save(); render();
}

function confirmMeal(ok){
  const text = ok ? "ğŸ± ì˜¤ëŠ˜ ì‹ë‹¨ì„ 'ì„±ê³µ'ìœ¼ë¡œ ê¸°ë¡í• ê¹Œìš”?" : "ğŸ± ì˜¤ëŠ˜ ì‹ë‹¨ì„ 'ì‹¤íŒ¨'ë¡œ ê¸°ë¡í• ê¹Œìš”?";
  if(!confirm(text + "\ní™•ì¸ì„ ëˆ„ë¥´ë©´ ì˜¤ëŠ˜ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.")) return;
  addMeal(ok);
}
function addMeal(ok){
  const d=today(); ensureDay(d);
  if(records[d].meal!==undefined) return;

  records[d].meal=ok;

  if(ok){
    addXpPart(d, "meal", 10);
    if(Math.random()<0.3){
      addMatPart(d, "meal", 1);
      showMsg("ğŸ± ì‹ë‹¨ ì„±ê³µ (ì¬ë£Œ +1)");
    }else{
      showMsg("ğŸ± ì‹ë‹¨ ì„±ê³µ");
    }
  }else{
    showMsg("ğŸ± ì‹ë‹¨ ì‹¤íŒ¨");
  }

  updateStreakOnAction(d);
  checkDailyBonus(d);
  save(); render();
}

/* =========================
   ë³´ìŠ¤ íŒ¨í„´
========================= */
const PATTERNS = {
  NORMAL: {name:"í‰íƒ€", hint:"ë³´ìŠ¤ê°€ ë§¤ì´ˆ ê³µê²©í•©ë‹ˆë‹¤."},
  HEAVY: {name:"ê°•ê³µ ì˜ˆê³ ", hint:"ê°•ê³µ! íšŒí”¼ ë²„íŠ¼ìœ¼ë¡œ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."},
  DEFEND: {name:"ë°©ì–´ íƒœì„¸", hint:"ë³´ìŠ¤ê°€ 5ì´ˆê°„ ë°›ëŠ” í”¼í•´ 50%."},
  LIFESTEAL: {name:"í¡í˜ˆ", hint:"ë³´ìŠ¤ê°€ ë•Œë¦¬ë©° ì²´ë ¥ì„ íšŒë³µí•©ë‹ˆë‹¤."}
};

function startBoss(){
  if(battle) return;

  state.bossHp = bossHpForLevel(state.bossLv);
  state.bossAtk = bossAtkForLevel(state.bossLv);

  battle={
    time:30,
    bossHp:state.bossHp,
    myHp:state.maxHp,
    pattern:"NORMAL",
    patternT:0,
    dmgMult:1.0,
    heavyWindup:0,
    heavyDodged:false,
    heavyArmed:false,
  };

  setPattern("NORMAL");

  $("bossBtn").innerText="ê³µê²©í•˜ê¸°";
  $("bossBtn").onclick=attackBoss;

  showMsg(`âš”ï¸ ë³´ìŠ¤ Lv${state.bossLv} ì „íˆ¬ ì‹œì‘`);

  bossTimer=setInterval(()=>{
    if(!battle) return;

    battle.time--;
    tickBossAI();
    tickBossAttack();

    $("timer").innerText=`ë‚¨ì€ ì‹œê°„ ${battle.time}s`;
    if(battle.time<=0 || battle.myHp<=0) endBoss(false);

    if(battle.time<=10){
      $("timer").style.color="#ff4444";
      $("timer").style.fontWeight="900";
    }else{
      $("timer").style.color="#bbb";
      $("timer").style.fontWeight="400";
    }
    render();
  },1000);
}

function setPattern(p){
  if(!battle) return;
  battle.pattern = p;
  battle.patternT = 0;
  battle.dmgMult = 1.0;
  battle.heavyWindup = 0;
  battle.heavyDodged = false;
  battle.heavyArmed = false;

  if(p==="DEFEND"){
    battle.dmgMult = 0.5;
  }
  if(p==="HEAVY"){
    battle.heavyWindup = 3;
    battle.heavyArmed = true;
    $("dodgeBtn").disabled = false;
  }else{
    $("dodgeBtn").disabled = true;
  }
}

function useDodge(){
  if(!battle) return;
  if(battle.pattern!=="HEAVY" || !battle.heavyArmed) return;
  battle.heavyDodged = true;
  battle.heavyArmed = false;
  $("dodgeBtn").disabled = true;
  showMsg("ğŸ›¡ï¸ íšŒí”¼ ì¤€ë¹„ ì™„ë£Œ!");
  flashOverlay("DODGE!");
}

function tickBossAI(){
  if(!battle) return;
  battle.patternT += 1;

  if(battle.pattern==="HEAVY"){
    return;
  }
  if(battle.patternT >= 5){
    const roll = Math.random();
    let next="NORMAL";
    if(roll < 0.15) next="HEAVY";
    else if(roll < 0.45) next="DEFEND";
    else if(roll < 0.70) next="LIFESTEAL";
    else next="NORMAL";
    setPattern(next);
  }
}

function tickBossAttack(){
  if(!battle) return;

  const atk = state.bossAtk;

  if(battle.pattern==="HEAVY"){
    battle.heavyWindup -= 1;

    if(battle.heavyWindup > 0){
      return;
    }
    const heavyDmg = Math.floor(atk * 2.5);

    if(battle.heavyDodged){
      showMsg("âœ… ê°•ê³µ íšŒí”¼ ì„±ê³µ!");
      flashOverlay("EVADE!");
    }else{
      battle.myHp -= heavyDmg;
      showMsg(`ğŸ’¥ ê°•ê³µ! -${heavyDmg} HP`);
      $("bossCard").classList.add("shake");
      setTimeout(()=>$("bossCard").classList.remove("shake"),180);
    }
    $("dodgeBtn").disabled = true;

    setPattern("NORMAL");
    return;
  }

  if(battle.pattern==="LIFESTEAL"){
    const dmg = Math.floor(atk * 0.8);
    const heal = Math.floor(atk * 0.4);

    battle.myHp -= dmg;
    battle.bossHp = Math.min(state.bossHp, battle.bossHp + heal);
    return;
  }

  battle.myHp -= atk;
}

function attackBoss(){
  if(!battle) return;

  let dmg=state.atk;
  let crit=false;
  if(Math.random()*100 < state.crit){ dmg*=2; crit=true; }

  const realDmg = Math.max(1, Math.floor(dmg * (battle.dmgMult||1)));
  battle.bossHp -= realDmg;

  $("bossCard").classList.add("shake");
  setTimeout(()=>$("bossCard").classList.remove("shake"),180);

  damagePopup(crit ? `CRIT ${realDmg}` : `${realDmg}`, crit);

  if(battle.bossHp<=0) endBoss(true);
  render();
}

function endBoss(win){
  clearInterval(bossTimer);
  bossTimer=null;
  battle=null;

  $("bossBtn").innerText="ë³´ìŠ¤ì „ ì‹œì‘";
  $("bossBtn").onclick=startBoss;
  $("timer").innerText="";
  $("timer").style.color="#bbb";
  $("timer").style.fontWeight="400";
  $("dodgeBtn").disabled = true;

  const d=today(); ensureDay(d);

  if(win){
    addXpPart(d, "boss", 50);
    addMatPart(d, "boss", 1);
    records[d].bossWins = (records[d].bossWins||0) + 1;

    state.bossLv += 1;
    state.bossHp = bossHpForLevel(state.bossLv);
    state.bossAtk = bossAtkForLevel(state.bossLv);

    flashOverlay("VICTORY!");
  }else{
    state.bossHp = bossHpForLevel(state.bossLv);
    state.bossAtk = bossAtkForLevel(state.bossLv);
    flashOverlay("DEFEAT");
  }

  save(); render();
}

/* =========================
   ì¥ë¹„
========================= */
function upgradeGear(i){
  const g = state.gears[i];
  const locked = state.lv < g.req;
  if(locked) return;

  const cost = g.lv + 1;
  if(state.mat < cost) { showMsg("ì¬ë£Œ ë¶€ì¡±"); return; }

  state.mat -= cost;
  g.lv += 1;

  if(i===0){ state.atk += 1; }
  if(i===1){ state.maxHp += 10; state.hp += 10; }
  if(i===2){ state.crit += 0.5; }
  if(i===3){ state.atk += 1; state.crit += 0.5; }

  showMsg(`ğŸ›¡ï¸ ${g.name} ê°•í™” ì„±ê³µ! (Lv ${g.lv})`);
  flashOverlay("UPGRADE!");
  save(); render();
}
function gearEffectText(i){
  if(i===0) return "íš¨ê³¼: ê³µê²©ë ¥ +1/ê°•í™”";
  if(i===1) return "íš¨ê³¼: ìµœëŒ€HP +10/ê°•í™”";
  if(i===2) return "íš¨ê³¼: ì¹˜ëª…íƒ€ +0.5%/ê°•í™”";
  return "íš¨ê³¼: ê³µê²©ë ¥ +1 & ì¹˜ëª…íƒ€ +0.5%/ê°•í™”";
}

/* =========================
   ì·¨ì†Œ / ìˆ˜ì •
========================= */
function undoToday(kind){
  const d=today(); ensureDay(d);
  const r=records[d];

  if(kind==="run"){
    if(r.run===undefined){ showMsg("ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ê¸°ë¡ ì—†ìŒ"); return; }
    if(!confirm("ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ê¸°ë¡ì„ ì·¨ì†Œí• ê¹Œìš”?")) return;
    if(!confirm("ì •ë§ ì·¨ì†Œí•©ë‹ˆë‹¤.")) return;

    removeXpPart(d,"run");
    removeMatPart(d,"run");

    if(typeof r.run==="number" && !Number.isNaN(r.run)){
      state.runSum = Math.max(0, state.runSum - r.run);
    }
    delete r.run;

    showMsg("ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ì·¨ì†Œ ì™„ë£Œ");
    save(); render();
    return;
  }

  if(kind==="workout"){
    if(!r.workout){ showMsg("ì˜¤ëŠ˜ ê·¼ë ¥ìš´ë™ ê¸°ë¡ ì—†ìŒ"); return; }
    if(!confirm("ì˜¤ëŠ˜ ê·¼ë ¥ìš´ë™ ê¸°ë¡ì„ ì·¨ì†Œí• ê¹Œìš”?")) return;
    if(!confirm("ì •ë§ ì·¨ì†Œí•©ë‹ˆë‹¤.")) return;

    removeXpPart(d,"workout");
    r.workout=false;

    showMsg("ì˜¤ëŠ˜ ê·¼ë ¥ìš´ë™ ì·¨ì†Œ ì™„ë£Œ");
    save(); render();
    return;
  }

  if(kind==="meal"){
    if(r.meal===undefined){ showMsg("ì˜¤ëŠ˜ ì‹ë‹¨ ê¸°ë¡ ì—†ìŒ"); return; }
    if(!confirm("ì˜¤ëŠ˜ ì‹ë‹¨ ê¸°ë¡ì„ ì·¨ì†Œí• ê¹Œìš”?")) return;
    if(!confirm("ì •ë§ ì·¨ì†Œí•©ë‹ˆë‹¤.")) return;

    removeXpPart(d,"meal");
    removeMatPart(d,"meal");
    delete r.meal;

    showMsg("ì˜¤ëŠ˜ ì‹ë‹¨ ì·¨ì†Œ ì™„ë£Œ");
    save(); render();
    return;
  }
}

/* ìˆ˜ì • ëª¨ë‹¬ */
let editCtx=null;
function openEdit(title, bodyHtml){
  $("editTitle").innerText = title;
  $("editBody").innerHTML = bodyHtml;
  $("editModalBack").classList.add("show");
}
function closeEdit(e){
  if(e && e.target && e.target.id!=="editModalBack") return;
  $("editModalBack").classList.remove("show");
  editCtx=null;
}
function editTodayRun(){
  const d=today(); ensureDay(d);
  const r=records[d]||{};
  if(r.run===undefined){ showMsg("ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"); return; }

  editCtx={type:"run"};
  openEdit("âœï¸ ì˜¤ëŠ˜ ë‹¬ë¦¬ê¸° ìˆ˜ì •",
    `<div class="small">í˜„ì¬: <b>${r.run}km</b></div>
     <input id="editRunInput" type="number" step="0.1" value="${r.run}" placeholder="ìˆ˜ì •í•  km">
     <div class="small">â€» XP/ì¬ë£Œ(ëˆ„ì  10km)ëŠ” ìë™ ì¬ê³„ì‚°ë©ë‹ˆë‹¤.</div>`
  );
}
function editTodayMeal(){
  const d=today(); ensureDay(d);
  const r=records[d]||{};
  if(r.meal===undefined){ showMsg("ì˜¤ëŠ˜ ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"); return; }

  editCtx={type:"meal"};
  const cur = r.meal===true ? "ì„±ê³µ" : "ì‹¤íŒ¨";
  openEdit("âœï¸ ì˜¤ëŠ˜ ì‹ë‹¨ ìˆ˜ì •",
    `<div class="small">í˜„ì¬: <b>${cur}</b></div>
     <div class="grid2" style="margin-top:8px">
       <button id="editMealOk" onclick="selectMealEdit(true)">ì„±ê³µ</button>
       <button class="gray" id="editMealNo" onclick="selectMealEdit(false)">ì‹¤íŒ¨</button>
     </div>
     <div class="small">â€» XP(ì„±ê³µ +10 / ì‹¤íŒ¨ 0)ëŠ” ê·œì¹™ëŒ€ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.<br>
     ì¬ë£Œ(í™•ë¥  ë“œë)ëŠ” â€œìˆ˜ì • ì‹œ ì¬ì¶”ì²¨ ì—†ìŒâ€ â†’ ê¸°ì¡´ ê°’ ìœ ì§€</div>`
  );
  setTimeout(()=>{
    const isOk = (records[d].meal===true);
    highlightMealEdit(isOk);
    editCtx.mealTarget = isOk;
  },0);
}
function highlightMealEdit(ok){
  const okBtn=$("editMealOk"), noBtn=$("editMealNo");
  if(!okBtn||!noBtn) return;
  okBtn.className = ok ? "" : "gray";
  noBtn.className = ok ? "gray" : "";
}
function selectMealEdit(ok){
  if(!editCtx||editCtx.type!=="meal") return;
  editCtx.mealTarget = ok;
  highlightMealEdit(ok);
}
function applyEdit(){
  if(!editCtx) return;
  const d=today(); ensureDay(d);
  const r=records[d]||{};

  if(editCtx.type==="run"){
    const inp=$("editRunInput");
    if(!inp) return;
    const newKm=parseFloat(inp.value);
    if(!newKm || newKm<=0){ showMsg("km ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ"); return; }

    const oldKm = Number(r.run||0);

    removeXpPart(d,"run");
    removeMatPart(d,"run");
    if(oldKm>0) state.runSum = Math.max(0, state.runSum - oldKm);

    r.run = newKm;

    addXpPart(d,"run", Math.floor(newKm*20));

    const before=Math.floor(state.runSum/10);
    state.runSum += newKm;
    const after=Math.floor(state.runSum/10);
    const gained=Math.max(0, after-before);
    if(gained>0) addMatPart(d,"run",gained);

    showMsg(`âœï¸ ë‹¬ë¦¬ê¸° ìˆ˜ì • ì™„ë£Œ (${newKm}km)`);
    closeEdit();
    checkDailyBonus(d);
    save(); render();
    return;
  }

  if(editCtx.type==="meal"){
    if(r.meal===undefined){ showMsg("ì˜¤ëŠ˜ ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
    const target = !!editCtx.mealTarget;

    removeXpPart(d,"meal");
    r.meal = target;

    if(target){
      addXpPart(d,"meal",10);
      showMsg("âœï¸ ì‹ë‹¨ ìˆ˜ì •: ì„±ê³µ");
    }else{
      showMsg("âœï¸ ì‹ë‹¨ ìˆ˜ì •: ì‹¤íŒ¨");
    }

    closeEdit();
    checkDailyBonus(d);
    save(); render();
    return;
  }
}

/* =========================
   ë°±ì—…/ë³µì›
========================= */
function openBackup(){
  $("backupModalBack").classList.add("show");
  const payload = {state, records};
  $("backupText").value = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
}
function closeBackup(e){
  if(e && e.target && e.target.id!=="backupModalBack") return;
  $("backupModalBack").classList.remove("show");
}
function copyBackup(){
  const t=$("backupText");
  t.select(); t.setSelectionRange(0, t.value.length);
  try{ document.execCommand("copy"); showMsg("ë°±ì—… í…ìŠ¤íŠ¸ ë³µì‚¬ë¨"); }catch(_){ showMsg("ë³µì‚¬ ì‹¤íŒ¨(ìˆ˜ë™ ë³µì‚¬)"); }
}
function restoreBackup(){
  const raw = $("backupText").value.trim();
  if(!raw) return;
  if(!confirm("ë³µì›í•˜ë©´ í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì¨ì§‘ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
  try{
    const json = decodeURIComponent(escape(atob(raw)));
    const obj = JSON.parse(json);
    if(!obj || !obj.state || !obj.records) throw new Error("í˜•ì‹ ì˜¤ë¥˜");

    state = obj.state;
    records = obj.records;

    state.lv ??= 1;
    state.xp ??= 0;
    state.maxXp ??= (100 + 50*(state.lv-1));
    state.maxHp ??= 50;
    state.hp ??= Math.min(state.hp ?? state.maxHp, state.maxHp);
    state.atk ??= 5;
    state.crit ??= 5;
    state.mat ??= 0;
    state.runSum ??= 0;

    state.bossLv ??= 1;
    state.bossHp = bossHpForLevel(state.bossLv);
    state.bossAtk = bossAtkForLevel(state.bossLv);

    state.gears ??= [
      {name:"ìš´ë™í™”",lv:0,req:5},
      {name:"ìš´ë™ë³µ",lv:0,req:10},
      {name:"ì†ëª©ë°´ë“œ",lv:0,req:15},
      {name:"í—¤ë“œì…‹",lv:0,req:20}
    ];
    state.streak ??= 0;
    state.lastStreakDate ??= "";
    state.lastStreakRewardDate ??= "";
    state.spentSP ??= 0;
    state.statLog ??= [];
    state.quests ??= {dailyKey:"", weeklyKey:"", claimed:{}};
    state.quests.claimed ??= {};

    /* âœ… ë³µì› í›„ì—ë„ ìŠ¤í‚¨ ì •ì±… ì ìš© */
    state.skins ??= { current:"neon", unlocked:{neon:true,maple:false,retro:false}, seenUnlock:{neon:true,maple:false,retro:false} };
    state.skins.current ??= "neon";
    state.skins.unlocked ??= {neon:true,maple:false,retro:false};
    state.skins.seenUnlock ??= {neon:true,maple:false,retro:false};
    state.skins.unlocked.neon = true;
    state.skins.seenUnlock.neon = true;

    setStateFromTotalXP(totalXPFromState());

    save();
    showMsg("ë³µì› ì™„ë£Œ");
    closeBackup();
    initSkin();
    render();
  }catch(e){
    showMsg("ë³µì› ì‹¤íŒ¨: í…ìŠ¤íŠ¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ");
  }
}

/* =========================
   ìº˜ë¦°ë” ìƒì„¸
========================= */
function openDetail(dateStr){
  ensureDay(dateStr);
  const r=records[dateStr]||{};
  const run = (r.run!==undefined) ? `${r.run}km` : "ì—†ìŒ";
  const workout = r.workout ? "ì™„ë£Œ" : "ë¯¸ì™„ë£Œ";
  const meal = (r.meal===true) ? "ì„±ê³µ" : (r.meal===false) ? "ì‹¤íŒ¨" : "ë¯¸ì…ë ¥";
  const xp = r.xpGained||0;
  const parts = r.xpParts||{};
  const mats = r.matParts||{};
  const lines = [
    `<b>${dateStr}</b>`,
    `ë‹¬ë¦¬ê¸°: ${run}`,
    `ê·¼ë ¥: ${workout}`,
    `ì‹ë‹¨: ${meal}`,
    `ë³´ìŠ¤ ì²˜ì¹˜: ${r.bossWins||0}íšŒ`,
    `íšë“ XP: ${xp}`,
    `XP ìƒì„¸: (ë‹¬ë¦¬ê¸° ${parts.run||0}, ê·¼ë ¥ ${parts.workout||0}, ì‹ë‹¨ ${parts.meal||0}, ìŠ¤íŠ¸ë¦­ ${parts.streak||0}, ì˜¬í´ë¦¬ì–´ ${parts.dailyBonus||0}, ë³´ìŠ¤ ${parts.boss||0}, í€˜ìŠ¤íŠ¸ ${Object.keys(parts).filter(k=>k.startsWith("quest_")).reduce((s,k)=>s+(parts[k]||0),0)})`,
    `ì¬ë£Œ: (ë‹¬ë¦¬ê¸° ${mats.run||0}, ì‹ë‹¨ ${mats.meal||0}, ë³´ìŠ¤ ${mats.boss||0}, í€˜ìŠ¤íŠ¸ ${Object.keys(mats).filter(k=>k.startsWith("quest_")).reduce((s,k)=>s+(mats[k]||0),0)})`,
    r.dailyBonusGiven ? "ì˜¬í´ë¦¬ì–´ ë³´ë„ˆìŠ¤: ì§€ê¸‰ë¨" : "ì˜¬í´ë¦¬ì–´ ë³´ë„ˆìŠ¤: ë¯¸ì§€ê¸‰"
  ];
  $("detailBody").innerHTML = lines.join("<br>");
  $("detailModalBack").classList.add("show");
}
function closeDetail(e){
  if(e && e.target && e.target.id!=="detailModalBack") return;
  $("detailModalBack").classList.remove("show");
}
function jumpToToday(){
  closeDetail();
  location.hash="#work";
}

/* =========================
   ì´ˆê¸°í™”
========================= */
function resetAll(){
  const v = prompt("ì´ˆê¸°í™”í•˜ë ¤ë©´ RESET ì„ ì…ë ¥í•˜ì„¸ìš”.");
  if(v !== "RESET") { showMsg("ì´ˆê¸°í™” ì·¨ì†Œ"); return; }
  if(!confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
  localStorage.clear();
  location.reload();
}

/* =========================
   ê·¸ë˜í”„
========================= */
let chartDays=7;
function setChartDays(n){
  chartDays=n;
  renderCharts();
  showMsg(`ê·¸ë˜í”„ ê¸°ê°„: ìµœê·¼ ${n}ì¼`);
}
let runChart=null, xpChart=null;
function buildSeries(daysCount){
  const end=today();
  const days=[];
  for(let i=daysCount-1;i>=0;i--) days.push(addDaysISO(end,-i));
  const labels=days.map(fmtMMDD);
  const runData=days.map(d=> (records[d] && records[d].run!==undefined) ? Number(records[d].run) : 0);
  const xpData=days.map(d=> (records[d] && records[d].xpGained!==undefined) ? Number(records[d].xpGained) : 0);
  return {labels, runData, xpData, start:days[0], end:days[days.length-1]};
}
function renderCharts(){
  if(!window.Chart) return;

  const {labels, runData, xpData, start, end}=buildSeries(chartDays);
  $("chartRange1").innerText = `${fmtMMDD(start)} ~ ${fmtMMDD(end)}`;
  $("chartRange2").innerText = `${fmtMMDD(start)} ~ ${fmtMMDD(end)}`;

  const runCtx=$("runChart").getContext("2d");
  const xpCtx=$("xpChart").getContext("2d");

  if(runChart) runChart.destroy();
  if(xpChart) xpChart.destroy();

  runChart=new Chart(runCtx,{
    type:"line",
    data:{labels, datasets:[{label:"km", data:runData, tension:0.35, fill:false}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  xpChart=new Chart(xpCtx,{
    type:"line",
    data:{labels, datasets:[{label:"XP", data:xpData, tension:0.35, fill:false}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
}

/* =========================
   ë„ì›€ë§(ì„¤ëª…ì°½)
========================= */
const HELP = {
  all: {
    title: "ğŸ“– ì „ì²´ ì‹œìŠ¤í…œ ì„¤ëª…",
    html: `
    <div class="small">
      <b>ì´ ê²Œì„ì€ â€œìš´ë™ ìŠµê´€ + RPG ì„±ì¥â€ì„ ê²°í•©í•œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</b><br><br>

      âœ” ì‹¤ì œ í–‰ë™(ë‹¬ë¦¬ê¸° / ê·¼ë ¥ / ì‹ë‹¨)ì„ ê¸°ë¡í•˜ë©´<br>
      â†’ ê²½í—˜ì¹˜(XP), ì¬ë£Œ, ë ˆë²¨, ìŠ¤íƒ¯ì´ ì„±ì¥í•©ë‹ˆë‹¤.<br><br>

      <b>ê¸°ë³¸ íë¦„</b>
      <ul class="ul">
        <li>ìš´ë™/ì‹ë‹¨ ê¸°ë¡ â†’ XP íšë“</li>
        <li>XPë¡œ ë ˆë²¨ì—… â†’ ìŠ¤íƒ¯ í¬ì¸íŠ¸ íšë“</li>
        <li>ìŠ¤íƒ¯ ê°•í™” â†’ ë³´ìŠ¤ ê³µëµ ì‰¬ì›Œì§</li>
        <li>ë³´ìŠ¤ ì²˜ì¹˜ â†’ ì¬ë£Œ + ì¶”ê°€ XP</li>
        <li>ì¬ë£Œ â†’ ì¥ë¹„ ê°•í™”</li>
      </ul>

      <b>ìŠ¤í‚¨(í…Œë§ˆ)</b>
      <ul class="ul">
        <li>í‘œì‹œ ìˆœì„œ: <b>ë„¤ì˜¨ â†’ ë©”ì´í”Œí’ â†’ ë ˆíŠ¸ë¡œ ê²Œì„ë³´ì´</b></li>
        <li>ë„¤ì˜¨: <b>ê¸°ë³¸</b></li>
        <li>ë©”ì´í”Œí’: <b>ë ˆë²¨ 10</b> í•´ê¸ˆ</li>
        <li>ë ˆíŠ¸ë¡œ: <b>ì—°ì† ì¶œì„ 15ì¼</b> í•´ê¸ˆ</li>
      </ul>
    </div>`
  },
  status:{ title:"ğŸ“Œ ìƒíƒœì°½ ì„¤ëª…", html:`<div class="small">ìƒíƒœì°½: ë ˆë²¨/XP/HP/ìŠ¤íƒ¯/ì¬ë£Œ/ì—°ì†ì¶œì„ì„ í‘œì‹œí•©ë‹ˆë‹¤.</div>` },
  stats:{ title:"ğŸ“ˆ ìŠ¤íƒ¯ ë¶„ë°°", html:`<div class="small">ë ˆë²¨ì—…ë§ˆë‹¤ 1í¬ì¸íŠ¸ íšë“. HP(+10), ê³µê²©ë ¥(+1), ì¹˜ëª…íƒ€(+0.5%)ë¥¼ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš´ë™ ì·¨ì†Œë¡œ ë ˆë²¨ì´ ë‚´ë ¤ê°€ë©´, ì˜¬ë ¸ë˜ ìŠ¤íƒ¯ë„ ìµœê·¼ë¶€í„° ìë™ ë¡¤ë°±ë©ë‹ˆë‹¤(Bì•ˆ).</div>` },
  work:{ title:"ğŸƒ ìš´ë™", html:`<div class="small">ë‹¬ë¦¬ê¸°: km ì…ë ¥ í›„ 1ì¼ 1íšŒ. XP=kmÃ—20. ëˆ„ì  ë‹¬ë¦¬ê¸° 10kmë§ˆë‹¤ ê°•í™”ì¬ë£Œ 1ê°œ. ê·¼ë ¥ìš´ë™: 1ì¼ 1íšŒ(+50 XP).</div>` },
  meal:{ title:"ğŸ± ì‹ë‹¨", html:`<div class="small">ì‹ë‹¨: 1ì¼ 1íšŒ(ì„±ê³µ/ì‹¤íŒ¨). ì„±ê³µ ì‹œ XP+10, 30% í™•ë¥ ë¡œ ì¬ë£Œ+1. ë²„íŠ¼ì€ ì‹¤ìˆ˜ ë°©ì§€ í™•ì¸ì°½ì´ ëœ¹ë‹ˆë‹¤.</div>` },
  boss:{ title:"ğŸ‘¹ ë³´ìŠ¤", html:`<div class="small">ë³´ìŠ¤ì „: 30ì´ˆ íƒ€ì„ì–´íƒ. ê³µê²©í•˜ê¸° ì—°íƒ€ë¡œ ë³´ìŠ¤ë¥¼ ì“°ëŸ¬ëœ¨ë¦¬ë©´ XP+50, ì¬ë£Œ+1, ë³´ìŠ¤ë ˆë²¨+1. íŒ¨í„´: í‰íƒ€/ê°•ê³µ(íšŒí”¼ ê°€ëŠ¥)/ë°©ì–´(í”¼í•´ ê°ì†Œ)/í¡í˜ˆ.</div>` },
  gear:{ title:"ğŸ›¡ï¸ ì¥ë¹„", html:`<div class="small">ì¥ë¹„ 4ì¢…: ìš´ë™í™”/ìš´ë™ë³µ/ì†ëª©ë°´ë“œ/í—¤ë“œì…‹. í•´ê¸ˆ ì¡°ê±´ì€ â€œë‚´ ë ˆë²¨â€. ê°•í™” ë¹„ìš©ì€ (í˜„ì¬ ì¥ë¹„ë ˆë²¨+1) ì¬ë£Œë¥¼ ì†Œëª¨. ê°•í™” ì‹œ ìŠ¤íƒ¯ ìƒìŠ¹.</div>` },
  calendar:{ title:"ğŸ“… ìº˜ë¦°ë”", html:`<div class="small">ë‚ ì§œë³„ë¡œ ë‹¬ë¦¬ê¸°(km), ê·¼ë ¥, ì‹ë‹¨, XP, ë³´ìŠ¤ ì²˜ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ë‚ ì§œë¥¼ ëˆ„ë¥´ë©´ ìƒì„¸ê°€ ëœ¹ë‹ˆë‹¤.</div>` },
  charts:{ title:"ğŸ“Š ê·¸ë˜í”„", html:`<div class="small">ìµœê·¼ 7ì¼/30ì¼ ë‹¬ë¦¬ê¸°(km) ê·¸ë˜í”„ì™€ XP íšë“ëŸ‰ ê·¸ë˜í”„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>` },
  quest:{ title:"ğŸ§¾ í€˜ìŠ¤íŠ¸", html:`<div class="small">ì¼ì¼/ì£¼ê°„ í€˜ìŠ¤íŠ¸ë¥¼ ë‹¬ì„±í•˜ë©´ â€œë³´ìƒë°›ê¸°â€ ë²„íŠ¼ìœ¼ë¡œ XP/ì¬ë£Œë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>` },
  reset:{ title:"âš ï¸ ì „ì²´ ì´ˆê¸°í™”", html:`<div class="small">RESETì„ ì…ë ¥í•˜ê³  í™•ì¸í•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤(ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ).</div>` }
};

function openHelp(key){
  const k = HELP[key] ? key : "all";
  $("helpTitle").innerText = HELP[k].title;
  $("helpBody").innerHTML = HELP[k].html;
  $("helpModalBack").classList.add("show");
}
function closeHelp(e){
  if(e && e.target && e.target.id!=="helpModalBack") return;
  $("helpModalBack").classList.remove("show");
}

/* =========================
   ë³´ìŠ¤ íŒ¨í„´ UI í…ìŠ¤íŠ¸
========================= */
function renderBossPattern(){
  if(!battle){
    $("patternText").innerText = "-";
    $("patternHint").innerText = "";
    return;
  }
  const p = battle.pattern;
  if(p==="HEAVY"){
    $("patternText").innerText = `ê°•ê³µ ì˜ˆê³  (${Math.max(0,battle.heavyWindup)}s)`;
    $("patternHint").innerText = PATTERNS.HEAVY.hint;
    return;
  }
  $("patternText").innerText = PATTERNS[p]?.name || p;
  $("patternHint").innerText = PATTERNS[p]?.hint || "";
}

/* =========================
   ë Œë”
========================= */
let lastRenderedLv = state.lv;

function render(){
  if(state.lv > lastRenderedLv){
    $("status").classList.add("levelup");
    setTimeout(()=>$("status").classList.remove("levelup"),600);
    flashOverlay("LEVEL UP!");
  }
  lastRenderedLv = state.lv;

  tryUnlockSkins();
  renderSkinSelect();

  $("lv").innerText=state.lv;
  $("xpText").innerText=`${state.xp}/${state.maxXp}`;
  $("xpBar").style.width=(state.xp/state.maxXp*100)+"%";

  $("hpText").innerText=`${state.hp}/${state.maxHp}`;
  $("hpBar").style.width=(state.hp/state.maxHp*100)+"%";

  $("atk").innerText=state.atk;
  $("crit").innerText=Number(state.crit).toFixed(1);
  $("sp").innerText=freeSP();
  $("mat").innerText=state.mat;
  $("streak").innerText=state.streak||0;

  const nextIn = (3 - ((state.streak||0)%3))%3;
  $("streakNext").innerText = nextIn===0 ? "(ë‹¤ìŒ ë³´ìƒ: ì˜¤ëŠ˜ ê°€ëŠ¥)" : `(ë‹¤ìŒ ë³´ìƒê¹Œì§€ ${nextIn}ì¼)`;

  const d=today(); ensureDay(d);
  const r=records[d]||{};
  const hasRun = r.run!==undefined;
  const hasWorkout = r.workout===true;
  const hasMeal = r.meal!==undefined;
  const mealSuccess = r.meal===true;

  const pills=[];
  pills.push(`<div class="pill ${hasRun?"ok":"no"}">ë‹¬ë¦¬ê¸° ${hasRun?("âœ… "+r.run+"km"):"âŒ"}</div>`);
  pills.push(`<div class="pill ${hasWorkout?"ok":"no"}">ê·¼ë ¥ ${hasWorkout?"âœ…":"âŒ"}</div>`);
  pills.push(`<div class="pill ${hasMeal?(mealSuccess?"ok":"warn"):"no"}">ì‹ë‹¨ ${hasMeal?(mealSuccess?"âœ…":"âŒ"):"âŒ"}</div>`);
  $("todayPills").innerHTML=pills.join("");

  const prog = (hasRun?1:0)+(hasWorkout?1:0)+(mealSuccess?1:0);
  $("dailyProgress").innerText = `${prog}/3`;

  $("runBtn").disabled = hasRun;
  $("runBtn").textContent = hasRun ? `ë‹¬ë¦¬ê¸° ì™„ë£Œ (${r.run}km)` : "ë‹¬ë¦¬ê¸°";
  $("editRunBtn").disabled = !hasRun;
  $("undoRunBtn").disabled = !hasRun;

  $("workoutBtn").disabled = hasWorkout;
  $("workoutBtn").textContent = hasWorkout ? "ê·¼ë ¥ìš´ë™ ì™„ë£Œ" : "ê·¼ë ¥ìš´ë™ (+50 XP)";
  $("undoWorkoutBtn").disabled = !hasWorkout;

  $("mealOkBtn").disabled = hasMeal;
  $("mealNoBtn").disabled = hasMeal;
  $("mealOkBtn").textContent = hasMeal ? (mealSuccess?"ì‹ë‹¨ ê¸°ë¡ë¨(ì„±ê³µ)":"ì‹ë‹¨ ê¸°ë¡ë¨(ì‹¤íŒ¨)") : "ì‹ë‹¨ ì„±ê³µ";
  $("mealNoBtn").textContent = hasMeal ? "ì‹ë‹¨ ê¸°ë¡ë¨" : "ì‹ë‹¨ ì‹¤íŒ¨";
  $("editMealBtn").disabled = !hasMeal;
  $("undoMealBtn").disabled = !hasMeal;

  state.bossHp = bossHpForLevel(state.bossLv);
  state.bossAtk = bossAtkForLevel(state.bossLv);

  $("bossLv").innerText=state.bossLv;
  $("bossAtk").innerText=state.bossAtk;

  const bh=battle?battle.bossHp:state.bossHp;
  $("bossHpText").innerText=Math.max(0,Math.floor(bh));
  $("bossHpBar").style.width=(Math.max(0,bh)/state.bossHp*100)+"%";

  const mh=battle?battle.myHp:state.maxHp;
  $("battleHpText").innerText=Math.max(0,Math.floor(mh));
  $("battleHpBar").style.width=(Math.max(0,mh)/state.maxHp*100)+"%";

  renderBossPattern();

  $("gear").innerHTML = state.gears.map((g,i)=>{
    const locked = state.lv < g.req;
    const cost = g.lv + 1;
    return `
      <div class="gear-item ${locked?"lock":""}">
        <div class="row">
          <span>${locked?"???":g.name}</span>
          <span>Lv ${g.lv}</span>
        </div>
        <div class="gear-sub">${locked?`í•´ê¸ˆ: ë‚´ ë ˆë²¨ ${g.req}`:gearEffectText(i)}</div>
        ${locked ? "" : `<button onclick="upgradeGear(${i})">ê°•í™” (ì¬ë£Œ ${cost}ê°œ)</button>`}
      </div>
    `;
  }).join("");

  const keys = Object.keys(records).sort().reverse();
  $("calendar").innerHTML = keys.map(dateStr=>{
    const rr=records[dateStr]||{};
    const run = (rr.run!==undefined) ? (rr.run+"km") : "âŒ";
    const w = rr.workout ? "ğŸ’ª" : "âŒ";
    const m = (rr.meal===true) ? "âœ…" : (rr.meal===false) ? "âŒ" : "âŒ";
    const xp = rr.xpGained||0;
    const bw = rr.bossWins||0;
    return `<div class="clickable" onclick="openDetail('${dateStr}')">${dateStr} | ë‹¬ë¦¬ê¸°:${run} | ê·¼ë ¥:${w} | ì‹ë‹¨:${m} <span class="muted">| XP:${xp} | ë³´ìŠ¤:${bw}</span></div>`;
  }).join("");

  renderQuests();
  save();
  renderCharts();
}

/* =========================
   ì‹œì‘
========================= */
initSkin();
setStateFromTotalXP(totalXPFromState());
ensureQuestReset();
render();
</script>

<!-- âœ… PWA: ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡(ì¶”ê°€) -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        await navigator.serviceWorker.register("./service-worker.js");
        console.log("âœ… Service Worker registered");
      } catch (e) {
        console.log("âŒ Service Worker register failed", e);
      }
    });
  }
</script>

</body>
  </html>
